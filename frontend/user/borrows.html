<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu m∆∞·ª£n c·ªßa t√¥i - Th∆∞ vi·ªán PTIT</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üìö Th∆∞ vi·ªán PTIT</h2>
            </div>
            <ul class="sidebar-nav">
                <li><a href="dashboard.html"><span>üìä</span> <span>Dashboard</span></a></li>
                <li><a href="books.html"><span>üìñ</span> <span>Danh s√°ch s√°ch</span></a></li>
                <li><a href="wishlist.html"><span>üõí</span> <span>Gi·ªè m∆∞·ª£n</span></a></li>
                <li><a href="borrows.html" class="active"><span>üìã</span> <span>Phi·∫øu m∆∞·ª£n c·ªßa t√¥i</span></a></li>
                <li><a href="#" onclick="logout()"><span>üö™</span> <span>ƒêƒÉng xu·∫•t</span></a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1>üìã Phi·∫øu m∆∞·ª£n c·ªßa t√¥i</h1>
                <p>Theo d√µi tr·∫°ng th√°i phi·∫øu m∆∞·ª£n s√°ch</p>
            </div>

            <!-- Filter -->
            <div class="search-box">
                <select class="filter-select" id="status-filter">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="pending">Ch·ªù duy·ªát</option>
                    <option value="approved">ƒê√£ duy·ªát (ƒëang m∆∞·ª£n)</option>
                    <option value="need_edit">C·∫ßn ch·ªânh s·ª≠a</option>
                    <option value="rejected">T·ª´ ch·ªëi</option>
                    <option value="returned">ƒê√£ tr·∫£</option>
                </select>
            </div>

            <!-- Borrows List -->
            <div id="borrows-container">
                <div class="loading"><div class="spinner"></div></div>
            </div>

            <div class="pagination" id="pagination"></div>
        </main>
    </div>

    <!-- View Borrow Modal -->
    <div class="modal-overlay" id="view-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Chi ti·∫øt phi·∫øu m∆∞·ª£n #<span id="borrow-id"></span></h3>
                <button class="modal-close" onclick="closeModal('view-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <strong>Tr·∫°ng th√°i:</strong> <span id="borrow-status"></span>
                </div>
                <div class="mb-2">
                    <strong>Ng√†y t·∫°o:</strong> <span id="borrow-created"></span>
                </div>
                <div class="mb-2" id="borrow-due-container">
                    <strong>H·∫°n tr·∫£:</strong> <span id="borrow-due"></span>
                </div>
                <div class="mb-2" id="borrow-note-container">
                    <strong>Ghi ch√∫ c·ªßa b·∫°n:</strong> <span id="borrow-note"></span>
                </div>
                <div class="mb-2" id="borrow-admin-note-container">
                    <strong>Ghi ch√∫ c·ªßa th·ªß th∆∞:</strong> <span id="borrow-admin-note" class="text-danger"></span>
                </div>

                <h4 class="mt-2 mb-1">Danh s√°ch s√°ch:</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>T√™n s√°ch</th>
                            <th>SL m∆∞·ª£n</th>
                        </tr>
                    </thead>
                    <tbody id="borrow-items-body"></tbody>
                </table>
            </div>
            <div class="modal-footer" id="borrow-actions"></div>
        </div>
    </div>

    <!-- Edit Borrow Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Ch·ªânh s·ª≠a phi·∫øu m∆∞·ª£n #<span id="edit-borrow-id"></span></h3>
                <button class="modal-close" onclick="closeModal('edit-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" id="edit-admin-note"></div>

                <div class="form-group">
                    <label class="form-label">Ng√†y tr·∫£ s√°ch *:</label>
                    <input type="date" class="form-control" id="edit-due-date" required style="max-width: 250px;">
                </div>

                <div id="edit-items-container"></div>

                <div class="form-group mt-2">
                    <label class="form-label">Ghi ch√∫:</label>
                    <textarea class="form-control" id="edit-note" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('edit-modal')">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveBorrowEdit()">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // Check auth
        if (!requireAuth()) {
            // Will redirect
        }

        let currentPage = 1;
        const pageSize = 10;
        let statusFilter = '';
        let currentBorrow = null;
        let editItems = [];

        // Load borrows
        async function loadBorrows() {
            const container = document.getElementById('borrows-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const data = await borrowsAPI.getBorrows(currentPage, pageSize, statusFilter);
                renderBorrows(data.items);
                renderPagination(document.getElementById('pagination'), currentPage, data.total_pages, (page) => {
                    currentPage = page;
                    loadBorrows();
                });
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        }

        function renderBorrows(borrows) {
            const container = document.getElementById('borrows-container');

            if (!borrows || borrows.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 64px; margin-bottom: 20px;">üìã</div>
                        <h3>Ch∆∞a c√≥ phi·∫øu m∆∞·ª£n n√†o</h3>
                        <p class="text-muted">H√£y th√™m s√°ch v√†o gi·ªè v√† t·∫°o phi·∫øu m∆∞·ª£n</p>
                        <a href="books.html" class="btn btn-primary mt-2">üìñ Xem danh s√°ch s√°ch</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = borrows.map(borrow => `
                <div class="card mb-2">
                    <div class="card-body d-flex justify-between align-center">
                        <div>
                            <h4>Phi·∫øu m∆∞·ª£n #${borrow.id}</h4>
                            <p class="text-muted">
                                üìÖ ${formatDateTime(borrow.created_at)} |
                                üìö ${borrow.items?.length || 0} ƒë·∫ßu s√°ch
                                ${borrow.due_date ? ` | ‚è∞ H·∫°n tr·∫£: ${formatDate(borrow.due_date)}` : ''}
                            </p>
                        </div>
                        <div class="d-flex align-center gap-1">
                            ${getStatusBadge(borrow.status)}
                            <button class="btn btn-sm btn-primary" onclick="viewBorrow(${borrow.id})">Chi ti·∫øt</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // View borrow
        async function viewBorrow(borrowId) {
            try {
                currentBorrow = await borrowsAPI.getBorrow(borrowId);

                document.getElementById('borrow-id').textContent = currentBorrow.id;
                document.getElementById('borrow-status').innerHTML = getStatusBadge(currentBorrow.status);
                document.getElementById('borrow-created').textContent = formatDateTime(currentBorrow.created_at);

                // Due date
                const dueContainer = document.getElementById('borrow-due-container');
                if (currentBorrow.due_date) {
                    dueContainer.style.display = 'block';
                    document.getElementById('borrow-due').textContent = formatDate(currentBorrow.due_date);
                } else {
                    dueContainer.style.display = 'none';
                }

                // Notes
                const noteContainer = document.getElementById('borrow-note-container');
                if (currentBorrow.note) {
                    noteContainer.style.display = 'block';
                    document.getElementById('borrow-note').textContent = currentBorrow.note;
                } else {
                    noteContainer.style.display = 'none';
                }

                const adminNoteContainer = document.getElementById('borrow-admin-note-container');
                if (currentBorrow.admin_note) {
                    adminNoteContainer.style.display = 'block';
                    document.getElementById('borrow-admin-note').textContent = currentBorrow.admin_note;
                } else {
                    adminNoteContainer.style.display = 'none';
                }

                // Items
                const itemsBody = document.getElementById('borrow-items-body');
                itemsBody.innerHTML = currentBorrow.items.map(item => `
                    <tr>
                        <td>${item.book?.title || 'N/A'}</td>
                        <td>${item.quantity}</td>
                    </tr>
                `).join('');

                // Actions
                const actionsDiv = document.getElementById('borrow-actions');
                let actionsHtml = '<button class="btn btn-secondary" onclick="closeModal(\'view-modal\')">ƒê√≥ng</button>';

                if (currentBorrow.status === 'need_edit') {
                    actionsHtml += `<button class="btn btn-warning" onclick="openEditModal()">‚úèÔ∏è Ch·ªânh s·ª≠a</button>`;
                }

                if (currentBorrow.status === 'pending' || currentBorrow.status === 'need_edit' || currentBorrow.status === 'rejected') {
                    actionsHtml += `<button class="btn btn-danger" onclick="cancelBorrow()">üóëÔ∏è H·ªßy phi·∫øu</button>`;
                }

                actionsDiv.innerHTML = actionsHtml;

                openModal('view-modal');
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }

        // Open edit modal
        function openEditModal() {
            closeModal('view-modal');

            document.getElementById('edit-borrow-id').textContent = currentBorrow.id;
            document.getElementById('edit-admin-note').textContent = currentBorrow.admin_note || 'Th·ªß th∆∞ y√™u c·∫ßu b·∫°n ch·ªânh s·ª≠a phi·∫øu m∆∞·ª£n';
            document.getElementById('edit-note').value = currentBorrow.note || '';
            document.getElementById('edit-due-date').value = currentBorrow.due_date || '';

            editItems = currentBorrow.items.map(item => ({
                book_id: item.book_id,
                quantity: item.quantity,
                book: item.book
            }));

            renderEditItems();
            openModal('edit-modal');
        }

        function renderEditItems() {
            const container = document.getElementById('edit-items-container');

            container.innerHTML = editItems.map((item, index) => `
                <div class="wishlist-item" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 10px;">
                    <div class="wishlist-item-info" style="flex: 1;">
                        <h4>${item.book?.title || 'N/A'}</h4>
                        <p class="${item.book?.available_quantity >= item.quantity ? 'text-success' : 'text-danger'}">
                            C√≤n ${item.book?.available_quantity || 0} cu·ªën
                        </p>
                    </div>
                    <div class="wishlist-item-quantity">
                        <button class="quantity-btn" onclick="updateEditQuantity(${index}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="quantity-btn" onclick="updateEditQuantity(${index}, 1)">+</button>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeEditItem(${index})">üóëÔ∏è</button>
                </div>
            `).join('');

            if (editItems.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Kh√¥ng c√≤n s√°ch n√†o. Vui l√≤ng h·ªßy phi·∫øu ho·∫∑c th√™m s√°ch.</p>';
            }
        }

        function updateEditQuantity(index, change) {
            editItems[index].quantity += change;
            if (editItems[index].quantity <= 0) {
                removeEditItem(index);
            } else {
                renderEditItems();
            }
        }

        function removeEditItem(index) {
            editItems.splice(index, 1);
            renderEditItems();
        }

        // Save borrow edit
        async function saveBorrowEdit() {
            if (editItems.length === 0) {
                showAlert('Phi·∫øu m∆∞·ª£n ph·∫£i c√≥ √≠t nh·∫•t 1 cu·ªën s√°ch!', 'danger');
                return;
            }

            const dueDate = document.getElementById('edit-due-date').value;
            if (!dueDate) {
                showAlert('Vui l√≤ng ch·ªçn ng√†y tr·∫£ s√°ch!', 'danger');
                return;
            }

            // Ki·ªÉm tra ng√†y tr·∫£ ph·∫£i sau ng√†y h√¥m nay
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selectedDate = new Date(dueDate);
            if (selectedDate <= today) {
                showAlert('Ng√†y tr·∫£ ph·∫£i sau ng√†y h√¥m nay!', 'danger');
                return;
            }

            const note = document.getElementById('edit-note').value;
            const items = editItems.map(i => ({
                book_id: i.book_id,
                quantity: i.quantity
            }));

            try {
                await borrowsAPI.updateBorrow(currentBorrow.id, note, items, dueDate);
                showAlert('ƒê√£ c·∫≠p nh·∫≠t phi·∫øu m∆∞·ª£n! Vui l√≤ng ƒë·ª£i th·ªß th∆∞ duy·ªát l·∫°i.', 'success');
                closeModal('edit-modal');
                loadBorrows();
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }

        // Cancel borrow
        async function cancelBorrow() {
            if (!confirmAction('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy phi·∫øu m∆∞·ª£n n√†y?')) return;

            try {
                await borrowsAPI.deleteBorrow(currentBorrow.id);
                showAlert('ƒê√£ h·ªßy phi·∫øu m∆∞·ª£n!', 'success');
                closeModal('view-modal');
                loadBorrows();
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }

        // Status filter handler
        document.getElementById('status-filter').addEventListener('change', (e) => {
            statusFilter = e.target.value;
            currentPage = 1;
            loadBorrows();
        });

        // Init
        loadBorrows();
    </script>
</body>
</html>

